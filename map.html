<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jonathan Da Silva: Map of pictures and their location</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 100vh; }
        body { margin: 0; }
        #infoBox {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%); /* centers both horizontally and vertically */
          background: white;
          border-radius: 8px;
          padding: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.3);
          display: none;
          z-index: 1000;
          max-width: 100vw;
          box-sizing: border-box;
        }
        #infoContent
        {
          display: flex;
          flex-direction: column;
          align-items: center;
          text-align: center;
        }
        .infoContent__image
        {
          display: block;
          margin-top: 5px;
          height: auto;
          max-width: 100vw;
          box-sizing: border-box;
        }
    </style>
</head>
<body>
<div id="map" role="application" aria-label="Interactive map showing pictures and their location"></div>
<div id="infoBox" role="dialog" aria-modal="true" aria-labelledby="infoContent" style="display:none;">
    <div id="infoContent"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="coordinates.js"></script>
<script src="isLarge.js"></script>
<script>
    (() => {
      // Determine language from URL
      const params = new URLSearchParams(window.location.search);
      const lang = (params.get("lang") === "fr") ? "fr" : "en";
      document.documentElement.setAttribute("lang", lang);

      // Load footer script dynamically
      const footerScript = document.createElement("script");
      footerScript.src = `footer-${lang}.js`;

      footerScript.onload = () => {
        // Hide unwanted elements from footer script
        document.querySelectorAll(".contact, .picture__block--large, .picture__block").forEach(el => {
          el.style.display = "none";
        });

        // Initialize map
        initMap();
      };

      document.head.appendChild(footerScript);

      function initMap() {
        const [centerLat, centerLng] = latitudeLongitude[653].split(",").map(Number);
        const map = L.map('map').setView([centerLat, centerLng], 8);

        // Add openstreetmap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const infoBox = document.getElementById('infoBox');
        const infoContent = document.getElementById('infoContent');

        function showInfo(content) {
          infoBox.style.display = 'block';
          infoBox.style.maxWidth = 100 + '%';
          infoContent.innerHTML = content;
          infoBox.focus();
        }

        function hideInfo() {
          infoBox.style.display = 'none';
          infoContent.innerHTML = '';
        }
        document.addEventListener('keydown', e => {
          if(e.key === 'Escape') hideInfo();
        });

        map.on('click', (e) => {
          if (!e.originalEvent.target.closest('.leaflet-interactive')) hideInfo();
        });

        // Function to determine marker radius based on screen size
        function getMarkerRadius() {
            const isMobile = window.matchMedia("(max-width: 768px)").matches;
            const isTablet = window.matchMedia("(min-width: 769px) and (max-width: 1024px)").matches;

            if(isMobile) return 10;
            if(isTablet) return 5;
            return 2;
        }
        const radius = getMarkerRadius();

        function generateRow(color, text) {
            const row = document.createElement("div");
            row.style.display = "flex";
            row.style.alignItems = "center";
            row.style.marginBottom = "2px";

            const box = document.createElement("span");
            box.style.backgroundColor = color;
            box.style.width = "20px";
            box.style.height = "20px";
            box.style.display = "inline-block";
            box.style.marginRight = "5px";

            const label = document.createElement("span");
            label.textContent = text;

            row.appendChild(box);
            row.appendChild(label);
            return row;
        }

        const legend = L.control({ position: 'topright' });

        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'info legend');
            div.style.padding = '5px';
            div.style.background = 'white';
            div.style.border = '1px solid #ccc';

            div.appendChild(generateRow('blue', 'Square format'));
            div.appendChild(generateRow('green', 'Large format'));
            div.appendChild(generateRow('grey', 'Shifted due to same coordinates'));

            return div;
        };

        legend.addTo(map);

        // Keep track of how many times each couple lat/lng appears
        const coordCount = {};
        // Add markers
        for (let i = 1; i < latitudeLongitude.length; i++) {
          if (!latitudeLongitude[i]) continue;

          let [lat, lng] = latitudeLongitude[i].split(",").map(Number);
          const isLargeFlag = isLarge[i];
          let color = isLargeFlag ? 'green' : 'blue';

          // Count duplicates
          const key = `${lat},${lng}`;
          coordCount[key] = (coordCount[key] || 0) + 1;
          const count = coordCount[key];
          if (count > 1) {
            // Slightly shift each duplicate to be able to see all them
            const offset = 0.0001; // a few meters
            const angle = (count - 1) * 90; // rotate 90 degrees each duplicate
            const rad = angle * Math.PI / 180;

            color = 'grey';
            lat += offset * Math.cos(rad);
            lng += offset * Math.sin(rad);
          }
          const statusText = text[i];
          const imagePath = `images/RandPic/picture_${i}.jpg`;

          const html = `
              <strong>${statusText}</strong>
              <img src="${imagePath}" alt="${statusText}" class="infoContent__image">
          `;

          const marker = L.circleMarker([lat, lng], {
            radius: radius,
            color,
            fillColor: color,
            fillOpacity: 0.8
          }).addTo(map);

          const markerEl = marker.getElement();
          if (markerEl) {
            markerEl.setAttribute('role', 'button');
            markerEl.setAttribute('aria-label', statusText);
          }

          marker.on('click', () => {
            showInfo(html);
          });
        }

        // Listen for screen size changes and update marker radii
        window.matchMedia("(max-width: 768px)").addEventListener('change', () => {
            map.eachLayer(layer => {
                if(layer instanceof L.CircleMarker){
                    layer.setRadius(getMarkerRadius());
                }
            });
        });
      }
    })();
</script>
</body>
</html>
